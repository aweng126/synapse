@namespace Synapse.Dashboard
@inherits NodeTemplate

<g class="node @(!string.IsNullOrWhiteSpace(Node.Shape) ? "shape-" + Node.Shape : "shape-rectangle") @Node.CssClass" transform="translate(@((Node.X ?? 0).ToInvariantString()), @((Node.Y ?? 0).ToInvariantString()))">
    <CascadingValue Name="Node" Value="Node">
        <NodeShapeTemplate />
        <CascadingValue Name="LabelTemplate" Value="LabelTemplate">
            <NodeLabelTemplate />
        </CascadingValue>
        <CascadingValue Name="Symbol" Value="WorkflowNode.Symbol">
            <NodeSymbolTemplate />
        </CascadingValue>
        <CascadingValue Name="ActiveInstances" Value="WorkflowNode.OperativeInstancesCount">
            <CascadingValue Name="FaultedInstances" Value="WorkflowNode.FaultedInstancesCount">
                    
            </CascadingValue>
        </CascadingValue>
        @if (Graph.EnableProfiling) {
            <circle cx="0" cy="0" r="1" fill="red" />
        }
    </CascadingValue>
</g>

    
@code {
    protected virtual IWorkflowNodeViewModel WorkflowNode => (IWorkflowNodeViewModel)this.Node;
    IBoundingBox bbox => Node.BBox!;

    RenderFragment? LabelTemplate => !string.IsNullOrWhiteSpace(WorkflowNode.Type) || !string.IsNullOrWhiteSpace(WorkflowNode.Content) ? (__builder) =>
    {
        <g class="label">
            <foreignObject x="@(bbox.X.ToInvariantString())"
                           y="@(bbox.Y.ToInvariantString())"
                           width="@(bbox.Width.ToInvariantString())"
                           height="@(bbox.Height.ToInvariantString())">
                <div class="label-content">
                    <h3>
                        @if (!string.IsNullOrWhiteSpace(Node.Label))
                        {
                            @Node.Label
                        }
                    </h3>
                    @if (!string.IsNullOrWhiteSpace(WorkflowNode.Type)) {
                        <p class="fw-bold">@WorkflowNode.Type</p>
                    }
                    @if (!string.IsNullOrWhiteSpace(WorkflowNode.Content))
                    {
                        <pre class="fw-light fst-italic">@WorkflowNode.Content</pre>
                    }
                </div>
            </foreignObject>
        </g>
    } : null;
}